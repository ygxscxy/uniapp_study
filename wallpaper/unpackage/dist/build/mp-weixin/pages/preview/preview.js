"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../service/modules/preview.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"preview",setup(o){const u=e.ref(!0),t=e.ref(null),s=e.ref(null),n=e.ref(0),i=e.ref([]),r=e.ref(null),v=e.ref(0),c=e.ref([]),p=e.ref({}),d=e.ref(""),m=e.ref("");e.onLoad((async e=>{if(r.value=e.id,d.value=e.title,m.value=e.type||"","share"===m.value){const a=await l.getSimpleWallDetail(e.id);i.value=a.data}})),e.onMounted((()=>{"share"===m.value?(i.value=i.value.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")}))),p.value=i.value[0]):(i.value=e.index.getStorageSync("storageClassifyList")||[],i.value=i.value.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")}))),v.value=i.value.findIndex((e=>e._id===r.value)),c.value.push(0===v.value?i.value.length:v.value-1,v.value,v.value===i.value.length?0:v.value+1),p.value=i.value[v.value])}));const h=()=>{t.value.open()},f=()=>{t.value.close()},g=()=>{s.value.open(),n.value=Number(p.value.score)},y=()=>{s.value.close()},w=async()=>{let{_id:a,classid:o,score:u}=p.value;const t=await l.setPreviewScore(o,a,u);0==t.errCode?(e.index.showToast({title:"评分成功",icon:"none"}),i.value[v.value].userScore=n.value,e.index.setStorageSync("storageClassifyList",i.value)):400==t.errCode&&e.index.showToast({title:t.errMsg,icon:"none"}),s.value.close()},x=()=>{u.value=!u.value},_=a=>{console.log(a),"share"!=a?e.index.navigateBack():e.index.reLaunch({url:"/pages/index/index"})},b=e=>{v.value=e.detail.current,c.value.push(0===v.value?i.value.length:v.value-1,v.value,v.value===i.value.length?0:v.value+1),c.value=Array.from(new Set(c.value)),p.value=i.value[v.value]},S=async()=>{try{e.index.showLoading({mask:!0,title:"下载中..."});let{_id:a,classid:o}=p.value;await l.getDownloadWall(o,a);e.index.getImageInfo({src:p.value.picurl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,fail:a=>{console.log(a),"saveImageToPhotosAlbum:fail auth deny"==a.errMsg?e.index.showModal({title:"提示",content:"需要开启授权保存图片",success:a=>{a.confirm&&e.index.openSetting({success:a=>{console.log(a),a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取授权失败",icon:"none"})}})}}):"saveImageToPhotosAlbum:fail cancel"==a.errMsg&&e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})}})},complete:()=>{e.index.hideLoading()},fail:a=>{e.index.showToast({title:"图片保存失败",icon:"error"})}})}catch(a){e.index.hideLoading()}};return e.onShareAppMessage((e=>({path:"/pages/preview/preview?id="+r.value+"&title="+d.value+"&type=share",title:"dbb壁纸分类列表"}))),e.onShareTimeline((()=>({title:"dbb壁纸分类列表",imageUrl:"/static/images/xxmLogo.png",query:"id="+r.value+"&title="+d.value+"&type=share"}))),(l,o)=>{var r,P,j,k,M,T;return e.e({a:e.f(i.value,((a,l,o)=>e.e({a:c.value.includes(l)||"share"==m.value},c.value.includes(l)||"share"==m.value?{b:e.o(x,a._id),c:a.picurl}:{},{d:a._id}))),b:v.value,c:e.o(b),d:u.value},u.value?e.e({e:"share"!=m.value},"share"!=m.value?{f:e.p({type:"back",color:"#fff",size:"20"}),g:e.o(_),h:e.unref(a.getStatusBarHeight)()+"px"}:{},{i:"share"==m.value},"share"==m.value?{j:e.p({type:"home",color:"#fff",size:"20"}),k:e.o((e=>_("share"))),l:e.unref(a.getStatusBarHeight)()+"px"}:{},{m:e.t(v.value+1),n:e.t(i.value.length),o:e.p({date:new Date,format:"hh:mm"}),p:e.p({date:new Date,format:"MM月dd日"}),q:e.p({type:"info",size:"28"}),r:e.o(h),s:e.p({type:"star",color:Boolean(null==(r=p.value)?void 0:r.userScore)?"red":"",size:"28"}),t:e.t(null==(P=p.value)?void 0:P.score),v:e.o(g),w:e.p({type:"download",size:"23"}),x:e.o(S)}):{},{y:e.p({type:"closeempty",size:"18",color:"#999"}),z:e.o(f),A:e.t(p.value._id),B:e.t(d.value),C:e.t(p.value.nickname),D:e.p({readonly:!0,touchable:!0,value:null==(j=p.value)?void 0:j.score,size:"16"}),E:e.t(null==(k=p.value)?void 0:k.score),F:e.t(p.value.description),G:e.f(p.value.tabs,((a,l,o)=>({a:e.t(a),b:a}))),H:e.sr(t,"020760fd-7",{k:"infoPopup"}),I:e.p({type:"bottom"}),J:e.p({type:"closeempty",size:"18",color:"#999"}),K:e.o(y),L:e.o((e=>n.value=e)),M:e.p({allowHalf:!0,modelValue:n.value}),N:e.t(n.value),O:e.t(Boolean(null==(M=p.value)?void 0:M.userScore)?"已评分":"确认评分"),P:e.o(w),Q:Boolean(null==(T=p.value)?void 0:T.userScore),R:e.sr(s,"020760fd-10",{k:"scorePopup"}),S:e.p({"is-mask-click":!1})})}}},u=e._export_sfc(o,[["__scopeId","data-v-020760fd"]]);o.__runtimeHooks=6,wx.createPage(u);
